<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Guided meditation experience with tranquil imagery and checkpoints">
  <title>Guided Meditation</title>
  <style>
    :root {
      --animation-duration-border: 3s;
      --transition-duration-fade: 0.5s;
      --checkpoint-hold-ms: 3000ms;
      --accent-hue-base: 0;
      --accent-hue-shift: 18;
      --accent-hue: var(--accent-hue-base);
      --surface-outline: hsla(var(--accent-hue), 85%, 55%, 0.45);
      --surface-bg: rgba(0, 0, 0, 0.24);
      --caption-bg: rgba(0, 0, 0, 0.42);
      --status-bg: rgba(24, 32, 42, 0.85);
      --text-primary: #f5f7ff;
      --shadow-soft: 0 12px 32px rgba(0, 0, 0, 0.35);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
    }

    body {
      min-height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(110, 30, 30, 0.32), transparent 55%),
                  radial-gradient(circle at 80% 80%, rgba(180, 60, 40, 0.28), transparent 60%),
                  #1a0505;
      color: var(--text-primary);
      overflow: hidden;
    }

    @keyframes radiateBorder {
      0%, 100% {
        box-shadow:
          0 0 1.5vmax 0 hsla(var(--accent-hue), 85%, 55%, 0.45),
          0 0 3vmax 0 hsla(var(--accent-hue), 85%, 55%, 0.3),
          0 0 4.5vmax 0 hsla(var(--accent-hue), 85%, 55%, 0.15);
      }
      50% {
        box-shadow:
          0 0 12vmax 6vmax hsla(var(--accent-hue), 85%, 55%, 0.55),
          0 0 18vmax 9vmax hsla(var(--accent-hue), 85%, 55%, 0.35),
          0 0 26vmax 13vmax hsla(var(--accent-hue), 85%, 55%, 0.2);
      }
    }

    .experience-shell {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }

    .asset-container {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
      z-index: 2;
    }

    .status-banner {
      position: absolute;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      display: none;
      padding: 12px 18px;
      max-width: min(78vw, 640px);
      border-radius: 12px;
      background: var(--status-bg);
      color: #f8faff;
      font-size: clamp(0.95rem, 0.6vw + 0.9rem, 1.1rem);
      line-height: 1.4;
      text-align: center;
      box-shadow: 0 10px 28px rgba(0, 0, 0, 0.35);
      z-index: 3;
    }

    .status-banner.is-visible {
      display: block;
    }

    .asset-stage {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity var(--transition-duration-fade) ease-in-out;
      pointer-events: none;
    }

    .asset-stage.is-active {
      opacity: 1;
      pointer-events: auto;
    }

    .media-frame {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      gap: 20px;
      margin: 0;
      padding: 16px 18px 24px;
    }

    .radiant-border {
      border: 3px solid var(--surface-outline);
      border-radius: 18px;
      background: var(--surface-bg);
      animation: radiateBorder var(--animation-duration-border) ease-in-out infinite;
    }

    .media-frame[data-type="transition"] {
      animation-duration: calc(var(--animation-duration-border) * 0.75);
    }

    .media-slot {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .media-slot > img,
    .media-slot > video {
      display: block;
      width: auto;
      height: auto;
      max-width: 78vw;
      max-height: 68vh;
      object-fit: contain;
    }

    .caption {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 14px;
      width: min(78vw, 680px);
      padding: 16px 22px;
      border-radius: 16px;
      background: var(--caption-bg);
      color: var(--text-primary);
      text-align: center;
      line-height: 1.5;
      font-size: clamp(1rem, 0.75vw + 0.95rem, 1.3rem);
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow-soft);
    }

    .caption-text {
      margin: 0;
      font-weight: 500;
      letter-spacing: 0.01em;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.65);
      -webkit-text-stroke: 0.35px rgba(0, 0, 0, 0.55);
    }

    .choices {
      list-style: none;
      padding: 0;
      margin: 0;
      display: none;
      gap: 10px;
      font-size: clamp(0.95rem, 0.65vw + 0.9rem, 1.15rem);
      color: rgba(242, 245, 255, 0.95);
    }

    .caption.has-choices .choices {
      display: grid;
    }
  </style>
</head>
<body>
  <main id="experience" class="experience-shell">
    <div
      id="sequence-source"
      data-sequence-source
      aria-hidden="true"
      hidden
    >
      <!-- Checkpoint 1 -->
      <section
        class="sequence"
        data-sequence-id="chakra-one"
        style="--accent-hue-base:0; --accent-hue-shift:18;"
      >
        <article
          data-sequence-item
          data-type="checkpoint"
          data-asset="checkpoints/1-1.png"
          data-caption="It's 7am. Time for our morning meditation."
          data-alt="Soft red dawn washes over a meditation room with four cushions circling a single candle."
        >
          <p data-sequence-notes>It's 7am. Time for our morning meditation.</p>
        </article>

        <article
          data-sequence-item
          data-type="transition"
          data-asset="transitions/1.mp4"
          data-caption="It's 7am. Time for our morning meditation."
          data-alt="Embers glow in slow motion, pulsing in deep crimson as the scene shifts."
        >
          <p data-sequence-notes>It's 7am. Time for our morning meditation.</p>
        </article>

        <article
          data-sequence-item
          data-type="checkpoint"
          data-asset="checkpoints/1-2.png"
          data-caption="I feel so relaxed. Let's get the day started."
          data-alt="Meditators sit in a circle, palms rooted to the floor while red lanterns glow around them."
        >
          <p data-sequence-notes>I feel so relaxed. Let's get the day started.</p>
        </article>
      </section>

      <!-- Checkpoint 2 -->
      <section
        class="sequence"
        data-sequence-id="kitchen"
        style="--accent-hue-base:28; --accent-hue-shift:48;"
      >
        <article
          data-sequence-item
          data-type="checkpoint"
          data-asset="checkpoints/2-1.png"
          data-caption="Making breakfast with my Meditation Artifacts family."
          data-alt="Morning light pours across a rustic kitchen as steam rises from cups on a wooden counter."
        >
          <p data-sequence-notes>Making breakfast with my Meditation Artifacts family.</p>
          <ul data-choice-list>
            <li data-choice-path="a">Path A</li>
            <li data-choice-path="b">Path B</li>
          </ul>
        </article>

        <article
          data-sequence-item
          data-type="transition"
          data-asset="transitions/2a.mp4"
          data-asset-alt="transitions/2b.mp4"
          data-caption="Making breakfast with my Meditation Artifacts family."
          data-alt="Ripples of orange light flow like water across a dark backdrop."
          data-choice-dependent="true"
        >
          <p data-sequence-notes>Making breakfast with my Meditation Artifacts family.</p>
        </article>

        <article
          data-sequence-item
          data-type="checkpoint"
          data-asset="checkpoints/2-2a.png"
          data-asset-alt="checkpoints/2-2b.png"
          data-caption="I love mate!"
          data-alt="Two friends pass a gourd of mate, laughing beside an amber-hued window."
          data-choice-dependent="true"
        >
          <p data-sequence-notes>I love mate!</p>
          <ul data-choice-list>
            <li data-choice-path="a">Path 3A</li>
            <li data-choice-path="b">Path 3B</li>
          </ul>
        </article>
      </section>

      <!-- Checkpoint 3 -->
      <section
        class="sequence"
        data-sequence-id="water"
        style="--accent-hue-base:46; --accent-hue-shift:64;"
      >
        <article
          data-sequence-item
          data-type="checkpoint"
          data-asset="checkpoints/3-1a.png"
          data-asset-alt="checkpoints/3-1b.png"
          data-caption="Morning cold plunge at L치car Lake."
          data-alt="Golden sunrise washes over waves as a practitioner stands grounded in wet sand."
          data-choice-dependent="true"
          data-choice-source="kitchen"
        >
          <p data-sequence-notes>Morning cold plunge at L치car Lake.</p>
        </article>

        <article
          data-sequence-item
          data-type="transition"
          data-asset="transitions/3a.mp4"
          data-asset-alt="transitions/3b.mp4"
          data-caption="Morning cold plunge at L치car Lake."
          data-alt="Bands of radiant light spin outward in shimmering yellows and golds."
          data-choice-dependent="true"
          data-choice-source="kitchen"
        >
          <p data-sequence-notes>Morning cold plunge at L치car Lake.</p>
        </article>

        <article
          data-sequence-item
          data-type="checkpoint"
          data-asset="checkpoints/3-2a.png"
          data-asset-alt="checkpoints/3-2b.png"
          data-caption="Brrr so cold!"
          data-alt="Meditators sit along the shoreline with palms forward, reflecting the sun."
          data-choice-dependent="true"
          data-choice-source="kitchen"
        >
          <p data-sequence-notes>Brrr so cold!</p>
        </article>
      </section>

      <!-- Checkpoint 4 -->
      <section
        class="sequence"
        data-sequence-id="chakra-four"
        style="--accent-hue-base:96; --accent-hue-shift:136;"
      >
        <article
          data-sequence-item
          data-type="checkpoint"
          data-asset="checkpoints/4-1.png"
          data-caption="Breathwork with Paul and Erika today."
          data-alt="Practitioners rest hands over their hearts in a sunlit studio draped with green textiles."
        >
          <p data-sequence-notes>Breathwork with Paul and Erika today.</p>
        </article>

        <article
          data-sequence-item
          data-type="transition"
          data-asset="transitions/4.mp4"
          data-caption="Breathwork with Paul and Erika today."
          data-alt="Bands of luminous green light ripple outward across a dark backdrop."
        >
          <p data-sequence-notes>Breathwork with Paul and Erika today.</p>
        </article>

        <article
          data-sequence-item
          data-type="checkpoint"
          data-asset="checkpoints/4-2.png"
          data-caption="Breathing with the collective."
          data-alt="Two friends rest back-to-back outdoors, palms open as soft green light pools around them."
        >
          <p data-sequence-notes>Breathing with the collective.</p>
        </article>
      </section>

      <!-- Checkpoint 5 -->
      <section
        class="sequence"
        data-sequence-id="chakra-five"
        style="--accent-hue-base:196; --accent-hue-shift:216;"
      >
        <article
          data-sequence-item
          data-type="checkpoint"
          data-asset="checkpoints/5-1.png"
          data-caption="Taking a moment to connect with Janne and Kaio, meditation teachers."
          data-alt="Two friends lounge on blankets in a backyard, one journaling while the other reads under filtered light."
        >
          <p data-sequence-notes>Taking a moment to connect with Janne and Kaio, meditation teachers.</p>
        </article>

        <article
          data-sequence-item
          data-type="transition"
          data-asset="transitions/5.mp4"
          data-caption="Taking a moment to connect with Janne and Kaio, meditation teachers."
          data-alt="Waves of blue light spiral forward like an echoing voice across midnight space."
        >
          <p data-sequence-notes>Taking a moment to connect with Janne and Kaio, meditation teachers.</p>
        </article>

        <article
          data-sequence-item
          data-type="checkpoint"
          data-asset="checkpoints/5-2.png"
          data-caption="Deepening my understanding of Buddhist meditation."
          data-alt="Two teachers share an open-hearted conversation near a warmly lit window."
        >
          <p data-sequence-notes>Deepening my understanding of Buddhist meditation.</p>
          <ul data-choice-list>
            <li data-choice-path="a">Path A</li>
            <li data-choice-path="b">Path B</li>
          </ul>
        </article>
      </section>

      <!-- Checkpoint 6 -->
      <section
        class="sequence"
        data-sequence-id="chakra-six"
        style="--accent-hue-base:260; --accent-hue-shift:284;"
      >
        <article
          data-sequence-item
          data-type="checkpoint"
          data-asset="checkpoints/6-1a.png"
          data-asset-alt="checkpoints/6-1b.png"
          data-caption="Heading to Le Village for a talk about vibecoding telegram chatbots."
          data-alt="A guide gestures toward a constellation chart while students journal in an indigo-lit classroom."
          data-choice-dependent="true"
          data-choice-source="chakra-five"
        >
          <p data-sequence-notes>Heading to Le Village for a talk about vibecoding telegram chatbots.</p>
        </article>

        <article
          data-sequence-item
          data-type="transition"
          data-asset="transitions/6.mp4"
          data-asset-alt="transitions/6b.mp4"
          data-caption="Heading to Le Village for a talk about vibecoding telegram chatbots."
          data-alt="Fractal indigo lights spiral inward, forming a luminous eye of awareness."
          data-choice-dependent="true"
          data-choice-source="chakra-five"
        >
          <p data-sequence-notes>Heading to Le Village for a talk about vibecoding telegram chatbots.</p>
        </article>

        <article
          data-sequence-item
          data-type="checkpoint"
          data-asset="checkpoints/6-2a.png"
          data-asset-alt="checkpoints/6-2b.png"
          data-caption="We made a meditation chatbot!"
          data-alt="Participants close their notebooks together beneath a vaulted classroom awash in deep blue glow."
          data-choice-dependent="true"
          data-choice-source="chakra-five"
        >
          <p data-sequence-notes>We made a meditation chatbot!</p>
        </article>
      </section>

      <!-- Checkpoint 7 -->
      <section
        class="sequence"
        data-sequence-id="chakra-seven"
        style="--accent-hue-base:300; --accent-hue-shift:328;"
      >
        <article
          data-sequence-item
          data-type="checkpoint"
          data-asset="checkpoints/7-1.png"
          data-caption="Another day is over."
          data-alt="Pilgrims climb stone steps toward a hilltop sanctuary beneath a violet dawn sky."
        >
          <p data-sequence-notes>Another day is over.</p>
        </article>

        <article
          data-sequence-item
          data-type="transition"
          data-asset="transitions/7.mp4"
          data-caption="Another day is over."
          data-alt="Streams of amethyst light fall like stardust through a darkened expanse."
        >
          <p data-sequence-notes>Another day is over.</p>
        </article>

        <article
          data-sequence-item
          data-type="checkpoint"
          data-asset="checkpoints/7-2.png"
          data-caption="This is real life."
          data-alt="Meditators kneel inside a candlelit sanctuary beneath a glowing rose window."
        >
          <p data-sequence-notes>This is real life.</p>
        </article>
      </section>

      <!-- Checkpoint 8 -->
      <section
        class="sequence"
        data-sequence-id="chakra-eight"
        style="--accent-hue-base:320; --accent-hue-shift:340;"
      >
        <article
          data-sequence-item
          data-type="checkpoint"
          data-asset="checkpoints/8-1.png"
          data-caption="Final meditation."
          data-alt="A serene final scene."
        >
          <p data-sequence-notes>Final meditation.</p>
        </article>

        <article
          data-sequence-item
          data-type="transition"
          data-asset="transitions/8.mp4"
          data-caption="Final meditation."
          data-alt="Final transition scene."
        >
          <p data-sequence-notes>Final meditation.</p>
        </article>

        <article
          data-sequence-item
          data-type="checkpoint"
          data-asset="checkpoints/8-2.png"
          data-caption="The journey continues."
          data-alt="The end of the meditation journey."
        >
          <p data-sequence-notes>The journey continues.</p>
        </article>
      </section>
    </div>

    <div id="asset-container" class="asset-container" aria-live="off"></div>
    <template id="stage">
      <div class="asset-stage" data-stage>
        <figure class="media-frame radiant-border" data-stage-figure>
          <div class="media-slot" data-media-slot></div>
          <figcaption class="caption" data-caption>
            <p class="caption-text" data-caption-text></p>
            <ul class="choices" data-choice-list aria-label="Available choices"></ul>
          </figcaption>
        </figure>
      </div>
    </template>
  </main>
  <script>
const parseDuration = (value, fallback = 0) => {
  if (!value) return fallback;
  const trimmed = value.trim();
  if (!trimmed) return fallback;
  if (trimmed.endsWith('ms')) return Number.parseFloat(trimmed);
  if (trimmed.endsWith('s')) return Number.parseFloat(trimmed) * 1000;
  const numeric = Number.parseFloat(trimmed);
  return Number.isNaN(numeric) ? fallback : numeric;
};

const cssDuration = (element, property, fallback = 0) =>
  parseDuration(getComputedStyle(element).getPropertyValue(property), fallback);

const buildAssetUrl = (asset) =>
  `/assets/${String(asset)
    .split('/')
    .map((segment) => encodeURIComponent(segment))
    .join('/')}`;

const isVideo = (item) =>
  item.type === 'transition' || /\.(mp4|webm|mov)$/i.test(String(item.asset));

const choiceState = {};

const readTimeline = () => {
  const source = document.querySelector('[data-sequence-source]');
  if (!source) throw new Error('Missing sequence source markup.');

  const sections = Array.from(source.querySelectorAll('section[data-sequence-id]'));
  if (!sections.length) throw new Error('No sequences declared in markup.');

  return sections.flatMap((section, index) => {
    const computed = getComputedStyle(section);
    const baseRaw = Number.parseFloat(computed.getPropertyValue('--accent-hue-base'));
    const shiftRaw = Number.parseFloat(computed.getPropertyValue('--accent-hue-shift'));

    const theme = {
      id: section.dataset.sequenceId || `sequence-${index}`,
      base: Number.isNaN(baseRaw) ? 215 : baseRaw,
      shift: Number.isNaN(shiftRaw)
        ? Number.isNaN(baseRaw)
          ? 215
          : baseRaw
        : shiftRaw,
    };

    return Array.from(section.querySelectorAll('[data-sequence-item]')).map(
      (element) => {
        const isChoiceDependent = element.dataset.choiceDependent === 'true';
        const choiceSource = element.dataset.choiceSource;
        
        const asset = element.dataset.asset?.trim();
        const assetAlt = element.dataset.assetAlt?.trim();
        
        if (!asset) {
          throw new Error('Sequence item missing asset path.');
        }

        const caption = element.dataset.caption?.trim() || '';
        const alt = element.dataset.alt?.trim() || caption;
        const holdRaw = element.dataset.hold;
        const holdMs = holdRaw ? Number.parseFloat(holdRaw) : null;
        const choices = Array.from(
          element.querySelectorAll('[data-choice-list] li')
        )
          .map((li) => ({
            text: li.textContent.trim(),
            path: li.dataset.choicePath || null,
          }))
          .filter((choice) => choice.text);

        return {
          type: element.dataset.type === 'transition' ? 'transition' : 'checkpoint',
          asset: asset,
          assetAlt: assetAlt || null,
          caption,
          alt,
          choices,
          theme,
          holdMs: Number.isFinite(holdMs) ? holdMs : null,
          sequenceId: theme.id,
          isChoiceDependent,
          choiceSource,
        };
      }
    );
  });
};

const mediaCache = new Map();

const ensureMedia = (item) => {
  let entry = mediaCache.get(item.asset);
  if (entry) {
    if (entry.type === 'image') {
      entry.element.alt = item.alt || item.caption || '';
    }
    return entry;
  }

  if (isVideo(item)) {
    const video = document.createElement('video');
    video.muted = true;
    video.setAttribute('muted', '');
    video.playsInline = true;
    video.setAttribute('playsinline', '');
    video.preload = 'auto';
    video.src = buildAssetUrl(item.asset);

    entry = {
      type: 'video',
      element: video,
      ready: new Promise((resolve, reject) => {
        const cleanup = () => {
          video.removeEventListener('canplaythrough', handleReady);
          video.removeEventListener('error', handleError);
        };
        const handleReady = () => {
          cleanup();
          resolve(video);
        };
        const handleError = () => {
          cleanup();
          reject(new Error(`Failed to preload video asset "${item.asset}"`));
        };
        if (video.readyState >= HTMLMediaElement.HAVE_FUTURE_DATA) {
          resolve(video);
          return;
        }
        video.addEventListener('canplaythrough', handleReady, { once: true });
        video.addEventListener('error', handleError, { once: true });
        video.load();
      }),
      reset() {
        video.pause();
        video.currentTime = 0;
      },
    };
  } else {
    const image = new Image();
    image.decoding = 'async';
    image.alt = item.alt || item.caption || '';
    image.src = buildAssetUrl(item.asset);

    entry = {
      type: 'image',
      element: image,
      ready: new Promise((resolve, reject) => {
        const cleanup = () => {
          image.removeEventListener('load', handleLoad);
          image.removeEventListener('error', handleError);
        };
        const handleLoad = () => {
          cleanup();
          resolve(image);
        };
        const handleError = () => {
          cleanup();
          reject(new Error(`Failed to preload image asset "${item.asset}"`));
        };
        if (image.complete && image.naturalWidth) {
          resolve(image);
          return;
        }
        image.addEventListener('load', handleLoad, { once: true });
        image.addEventListener('error', handleError, { once: true });
      }),
      reset() {},
    };
  }

  mediaCache.set(item.asset, entry);
  return entry;
};

const hue = (() => {
  const root = document.documentElement;
  let themeId = null;
  let base = 215;
  let shift = 215;
  let checkpoints = 0;

  const applyTheme = (theme) => {
    themeId = theme.id;
    base = theme.base;
    shift = theme.shift;
    checkpoints = 0;
    root.style.setProperty('--accent-hue-base', `${base}`);
    root.style.setProperty('--accent-hue-shift', `${shift}`);
    root.style.setProperty('--accent-hue', `${base}`);
  };

  return {
    use(theme) {
      if (!theme) return;
      if (theme.id !== themeId) {
        applyTheme(theme);
      }
      const currentHue = checkpoints >= 2 ? shift : base;
      root.style.setProperty('--accent-hue', `${currentHue}`);
    },
    markCheckpoint() {
      checkpoints += 1;
    },
  };
})();

const fadeDuration = () =>
  cssDuration(document.documentElement, '--transition-duration-fade', 0);

const checkpointHold = (item) =>
  item.holdMs ?? cssDuration(document.documentElement, '--checkpoint-hold-ms', 3000);

const playVideo = (video) =>
  new Promise((resolve) => {
    const finish = () => {
      video.removeEventListener('ended', finish);
      resolve();
    };
    video.addEventListener('ended', finish, { once: true });
    const attempt = video.play();
    if (attempt && typeof attempt.catch === 'function') {
      attempt.catch(finish);
    }
    setTimeout(() => {
      if (!video.paused || video.currentTime > 0) return;
      finish();
    }, 500);
  });

const hold = (ms) =>
  ms > 0
    ? new Promise((resolve) => {
        setTimeout(resolve, ms);
      })
    : Promise.resolve();

const createStageBuilder = (container, template) => {
  if (!(template instanceof HTMLTemplateElement)) {
    throw new Error('Missing stage template.');
  }

  let activeStage = null;

  const build = (item, entry) => {
    const fragment = template.content.cloneNode(true);
    const stage = fragment.querySelector('[data-stage]');
    if (!stage) {
      throw new Error('Stage template missing `[data-stage]` element.');
    }

    stage.dataset.type = item.type;
    const figure = stage.querySelector('[data-stage-figure]');
    if (figure) {
      figure.dataset.type = item.type;
    }

    const slot = stage.querySelector('[data-media-slot]');
    if (slot) {
      slot.innerHTML = '';
      slot.appendChild(entry.element);
    }

    const caption = stage.querySelector('[data-caption-text]');
    if (caption) caption.textContent = item.caption || '';

    const list = stage.querySelector('[data-choice-list]');
    if (list) {
      list.innerHTML = '';
      const hasPathChoices = item.choices.some(c => c.path);
      if (item.choices.length && hasPathChoices) {
        item.choices.forEach((choice) => {
          const li = document.createElement('li');
          li.textContent = choice.text;
          if (choice.path) {
            li.dataset.choicePath = choice.path;
          }
          list.appendChild(li);
        });
        list.hidden = false;
        list.setAttribute('aria-hidden', 'false');
        stage.querySelector('[data-caption]')?.classList.add('has-choices');
      } else {
        list.hidden = true;
        list.setAttribute('aria-hidden', 'true');
        stage.querySelector('[data-caption]')?.classList.remove('has-choices');
      }
    }

    return stage;
  };

  const show = (stage) => {
    if (activeStage) {
      activeStage.classList.remove('is-active');
      const previous = activeStage;
      const timeout = fadeDuration();
      setTimeout(() => previous.remove(), timeout + 50);
    }

    container.appendChild(stage);
    requestAnimationFrame(() => {
      stage.classList.add('is-active');
    });
    activeStage = stage;
  };

  return (item, entry) => {
    const stage = build(item, entry);
    show(stage);
    return stage;
  };
};

const waitForChoice = (stage, item) => {
  return new Promise((resolve) => {
    const hasPathChoices = item.choices.some(c => c.path);
    if (!hasPathChoices) {
      resolve(null);
      return;
    }

    const handleKeyPress = (event) => {
      const key = event.key.toLowerCase();
      if (key !== 'a' && key !== 'b') return;

      const choicePath = key;
      choiceState[item.sequenceId] = choicePath;

      document.removeEventListener('keydown', handleKeyPress);
      resolve(choicePath);
    };

    document.addEventListener('keydown', handleKeyPress, { once: true });
  });
};

const runTimeline = async (timeline, presentStage, startIndex = 0) => {
  let index = startIndex;
  
  while (index < timeline.length) {
    const item = timeline[index];
    
    if (item.isChoiceDependent && item.choiceSource && !choiceState[item.choiceSource]) {
      index++;
      continue;
    }

    const actualAsset = item.isChoiceDependent && item.choiceSource && choiceState[item.choiceSource] === 'b' && item.assetAlt
      ? item.assetAlt
      : item.asset;

    const displayItem = { ...item, asset: actualAsset };
    const entry = ensureMedia(displayItem);
    try {
      await entry.ready;
    } catch (error) {
      console.error(`Skipping asset "${displayItem.asset}"`, error);
      index++;
      continue;
    }

    entry.reset();
    hue.use(item.theme);
    if (item.type === 'checkpoint') {
      hue.markCheckpoint();
    }

    const stage = presentStage(displayItem, entry);
    
    const hasPathChoices = item.choices.some(c => c.path);
    if (item.type === 'checkpoint' && hasPathChoices) {
      await waitForChoice(stage, item);
      
      const newTimeline = readTimeline();
      const nextIndex = index + 1;
      if (nextIndex < newTimeline.length) {
        return await runTimeline(newTimeline, presentStage, nextIndex);
      }
    }

    if (entry.type === 'video') {
      await playVideo(entry.element);
    } else {
      await hold(checkpointHold(item));
    }
    
    index++;
  }
};

const bootstrap = async () => {
  try {
    const container = document.getElementById('asset-container');
    const template = document.getElementById('stage');
    if (!container || !template) {
      throw new Error('Stage container or template missing.');
    }

    const presentStage = createStageBuilder(container, template);
    
    const runSequence = async () => {
      const timeline = readTimeline();
      if (!timeline.length) {
        console.error('No sequence items available for playback.');
        return;
      }

      hue.use(timeline[0]?.theme);
      await runTimeline(timeline, presentStage);
    };

    await runSequence();
  } catch (error) {
    console.error('Unable to start guided meditation timeline.', error);
  }
};

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', bootstrap);
} else {
  bootstrap();
}
  </script>
</body>
</html>
